
> @maplelaw/backend@0.1.0 test:e2e
> jest --config ./test/jest-e2e.json test/invoicing-flow.e2e-spec.ts

[31m[Nest] 10638  - [39m12/11/2025, 9:00:15 PM [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39m[31minvalid input syntax for type date: "0NaN-aN-aN"[39m
QueryFailedError: invalid input syntax for type date: "0NaN-aN-aN"
    at PostgresQueryRunner.query (/Users/gjohnson/.gemini/antigravity/scratch/maplelaw/node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2/src/driver/postgres/PostgresQueryRunner.ts:325:19)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at InsertQueryBuilder.execute (/Users/gjohnson/.gemini/antigravity/scratch/maplelaw/node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2/src/query-builder/InsertQueryBuilder.ts:164:33)
    at SubjectExecutor.executeInsertOperations (/Users/gjohnson/.gemini/antigravity/scratch/maplelaw/node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2/src/persistence/SubjectExecutor.ts:435:42)
    at SubjectExecutor.execute (/Users/gjohnson/.gemini/antigravity/scratch/maplelaw/node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2/src/persistence/SubjectExecutor.ts:137:9)
    at EntityPersistExecutor.execute (/Users/gjohnson/.gemini/antigravity/scratch/maplelaw/node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2/src/persistence/EntityPersistExecutor.ts:182:21)
    at TimeEntriesService.create (/Users/gjohnson/.gemini/antigravity/scratch/maplelaw/apps/backend/src/modules/time-entries/time-entries.service.ts:60:9)
  console.error
    Time Entry Failed: {
      "statusCode": 500,
      "message": "Internal server error"
    }

      91 |
      92 |         if (res.status !== 201) {
    > 93 |             console.error('Time Entry Failed:', JSON.stringify(res.body, null, 2));
         |                     ^
      94 |         }
      95 |         expect(res.status).toBe(201);
      96 |

      at Object.<anonymous> (invoicing-flow.e2e-spec.ts:93:21)

FAIL test/invoicing-flow.e2e-spec.ts
  Invoicing & Revenue Flow (E2E)
    âœ• 1. Create Billable Time Entry (53 ms)
    âœ• 2. Generate Invoice from Time Entry (Ontario HST 13%) (14 ms)
    âœ• 3. Record Partial Payment (5 ms)
    âœ• 4. Record Remaining Payment (4 ms)

  â— Invoicing & Revenue Flow (E2E) â€º 1. Create Billable Time Entry

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

      93 |             console.error('Time Entry Failed:', JSON.stringify(res.body, null, 2));
      94 |         }
    > 95 |         expect(res.status).toBe(201);
         |                            ^
      96 |
      97 |         timeEntryId = res.body.id;
      98 |         expect(res.body.amount).toBe(500); // 2 * 250

      at Object.<anonymous> (invoicing-flow.e2e-spec.ts:95:28)

  â— Invoicing & Revenue Flow (E2E) â€º 2. Generate Invoice from Time Entry (Ontario HST 13%)

    expect(received).toBe(expected) // Object.is equality

    Expected: 500
    Received: 0

      119 |
      120 |         // Verify Content
    > 121 |         expect(res.body.subtotal).toBe(500);
          |                                   ^
      122 |         // ON HST is 13%
      123 |         const expectedTax = 500 * 0.13; // 65
      124 |

      at Object.<anonymous> (invoicing-flow.e2e-spec.ts:121:35)

  â— Invoicing & Revenue Flow (E2E) â€º 3. Record Partial Payment

    expected 200 "OK", got 400 "Bad Request"

      150 |                 paymentSource: 'external'
      151 |             })
    > 152 |             .expect(200);
          |              ^
      153 |
      154 |         expect(res.body.status).toBe('partial');
      155 |         expect(res.body.amountPaid).toBe(paymentAmount);

      at Object.<anonymous> (invoicing-flow.e2e-spec.ts:152:14)
      ----
      at Test._assertStatus (../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:309:14)
      at ../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:152:11)

  â— Invoicing & Revenue Flow (E2E) â€º 4. Record Remaining Payment

    expected 200 "OK", got 400 "Bad Request"

      168 |                 paymentSource: 'external'
      169 |             })
    > 170 |             .expect(200);
          |              ^
      171 |
      172 |         expect(res.body.status).toBe('paid');
      173 |         expect(res.body.amountPaid).toBe(565);

      at Object.<anonymous> (invoicing-flow.e2e-spec.ts:170:14)
      ----
      at Test._assertStatus (../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:309:14)
      at ../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:152:11)

Test Suites: 1 failed, 1 total
Tests:       4 failed, 4 total
Snapshots:   0 total
Time:        3.281 s, estimated 4 s
Ran all test suites matching /test\/invoicing-flow.e2e-spec.ts/i.
[31m[Nest] 10638  - [39m12/11/2025, 9:00:15 PM [31m  ERROR[39m [38;5;3m[AuditInterceptor] [39m[31mFailed to write audit log[39m
[31m[Nest] 10638  - [39m12/11/2025, 9:00:15 PM [31m  ERROR[39m [38;5;3m[AuditInterceptor] [39m[31mQueryFailedError: Connection terminated[39m
